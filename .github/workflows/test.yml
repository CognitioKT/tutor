name: Tests

# Only trigger on push because PR commit messages don't point anywhere useful.
# @see {@link https://github.com/cypress-io/github-action#record-test-results-on-cypress-dashboard}
on: [push]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Automatically load balance tests across machines using Cypress.
        # @see {@link https://github.com/cypress-io/github-action#parallel}
        containers: [1, 2, 3]
    steps:
      - uses: actions/checkout@v2
      # This action installs and caches dependencies (including Cypress), runs
      # the build, and then runs our integration tests.
      # @see {@link https://github.com/cypress-io/github-action}
      - uses: cypress-io/github-action@v2
        with:
          record: true
          parallel: true
          build: yarn build
          command: yarn test
        env:
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      # Report code coverage info (from `coverage/lcov.info`) to Coveralls.
      # @see {@link https://github.com/coverallsapp/github-action}
      - uses: coverallsapp/github-action@master
        with:
          parallel: true
          flag-name: run-${{ matrix.containers }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
  coverage:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: coverallsapp/github-action@master
        with:
          parallel-finished: true
          github-token: ${{ secrets.GITHUB_TOKEN }}

env:
  INTERCOM_APP_ID: ${{ secrets.INTERCOM_APP_ID }}
  ALGOLIA_APP_ID: ${{ secrets.ALGOLIA_APP_ID }}
  ALGOLIA_SEARCH_KEY: ${{ secrets.ALGOLIA_SEARCH_KEY }}
  ALGOLIA_ADMIN_KEY: ${{ secrets.ALGOLIA_ADMIN_KEY }}
  SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
  FIRESTORE_EMULATOR_HOST: ${{ secrets.FIRESTORE_EMULATOR_HOST }}
  FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
  FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
  FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
  FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
  FIREBASE_DATABASE_URL: ${{ secrets.FIREBASE_DATABASE_URL }}
  FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
  FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
  FIREBASE_MEASUREMENT_ID: ${{ secrets.FIREBASE_MEASUREMENT_ID }}
  FIREBASE_ADMIN_CLIENT_EMAIL: ${{ secrets.FIREBASE_ADMIN_CLIENT_EMAIL }}
  FIREBASE_ADMIN_KEY: ${{ secrets.FIREBASE_ADMIN_KEY }}
