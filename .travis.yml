os: linux
dist: focal

language: node_js
node_js: 12.18.3

addons:
  apt:
    packages:
      - libgconf-2.4 # Required by Cypress
  chrome: stable
  firefox: latest

cache:
  directories:
    - $HOME/.cache/Cypress
    - $HOME/.cache/firebase/emulators
    - $HOME/.cache/yarn
    - .next/cache

env:
  global:
    - NODE_ENV=test
  jobs:
    - BROWSER=electron PARALLEL=1
    - BROWSER=electron PARALLEL=2
    - BROWSER=electron PARALLEL=3
    - BROWSER=firefox PARALLEL=1
    - BROWSER=firefox PARALLEL=2
    - BROWSER=firefox PARALLEL=3
    - BROWSER=chrome PARALLEL=1
    - BROWSER=chrome PARALLEL=2
    - BROWSER=chrome PARALLEL=3

jobs:
  fast_finish: true
  allow_failures:
    - env: BROWSER=firefox PARALLEL=1
    - env: BROWSER=firefox PARALLEL=2
    - env: BROWSER=firefox PARALLEL=3
    - env: BROWSER=chrome PARALLEL=1
    - env: BROWSER=chrome PARALLEL=2
    - env: BROWSER=chrome PARALLEL=3

before_install:
  - openssl aes-256-cbc -K $encrypted_d8d0a41d2890_key -iv $encrypted_d8d0a41d2890_iv -in firebase/functions/.runtimeconfig.json.enc -out firebase/functions/.runtimeconfig.json -d

install:
  - yarn install --immutable --immutable-cache
  - cd firebase/functions
  - npm install

before_script:
  - npm run build
  - cd ../../
  - yarn start:firebase &>/dev/null & yarn wait-on http-get://localhost:8080
  - yarn build

script:
  - yarn start:next &>/dev/null & yarn wait-on http://localhost:3000
  - yarn start:cy --record --parallel --headless --group $BROWSER -b $BROWSER

after_script:
  - bash <(curl -s https://codecov.io/bash)
